{% extends 'admin/base.html' %}
{% block admin_content %}
<div class="row g-3">
  <div class="col-12 d-flex justify-content-between align-items-center">
    <h3 class="mb-3">Ventes Goodies</h3>
    <a class="btn btn-outline-secondary" href="{{ url_for('admin.goodies_products') }}"><i class="bi bi-box-seam"></i> Gérer les articles</a>
  </div>
  <div class="col-12 col-lg-8">
    <div class="row g-2">
      {% for p in products %}
      <div class="col-6 col-sm-4 col-md-3">
        <button type="button" class="btn btn-light w-100 h-100 border product-btn" data-id="{{ p.id }}" data-name="{{ p.name }}" data-price="{{ '%.2f'|format(p.price) }}" data-vat="{{ p.vat_rate }}" style="min-height:88px;">
          <div class="fw-semibold">{{ p.name }}</div>
          <div class="text-muted small">{{ '%.2f'|format(p.price) }} € TTC</div>
          <div class="text-muted small">TVA {{ p.vat_rate }}%</div>
        </button>
      </div>
      {% endfor %}
    </div>
  </div>
  <div class="col-12 col-lg-4">
    <form method="post" id="posForm">
      {{ csrf_form.csrf_token }}
      <input type="hidden" name="cart_json" id="cart_json">
      <input type="hidden" name="payment_method" id="payment_method">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">Panier</div>
            <div class="btn-group" role="group">
              <input type="radio" class="btn-check" name="pay" id="pay_card" autocomplete="off" checked>
              <label class="btn btn-outline-primary" for="pay_card"><i class="bi bi-credit-card"></i> Carte</label>
              <input type="radio" class="btn-check" name="pay" id="pay_cash" autocomplete="off">
              <label class="btn btn-outline-success" for="pay_cash"><i class="bi bi-cash"></i> Cash</label>
            </div>
          </div>
          <div id="cart_list" class="list-group mb-3"></div>
          <div class="d-flex justify-content-between"><span>Sous-total</span><span id="subtotal">0,00 €</span></div>
          <div class="d-flex justify-content-between"><span>Ajustement arrondi</span><span id="rounding">0,00 €</span></div>
          <div class="d-flex justify-content-between fw-bold fs-5 border-top pt-2"><span>Total</span><span id="total">0,00 €</span></div>
          <div class="d-grid mt-3">
            <button type="submit" class="btn btn-primary" id="submit_btn" disabled>Encaisser</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>
<script>
(function(){
  const fmt = n=> (n).toFixed(2).replace('.',',') + ' €';
  const q2 = n=> Number((Math.round(n*100)/100).toFixed(2));
  const round005 = n=> { const r = Math.round(n*20)/20; return q2(r); };
  const cart = new Map();
  function add(p){
    const id = String(p.id);
    const prev = cart.get(id) || {id, name:p.name, price: Number(p.price), vat: Number(p.vat), qty:0};
    prev.qty += 1; cart.set(id, prev); render();
  }
  function setQty(id, q){ const it = cart.get(id); if(!it) return; it.qty = Math.max(0, q); if(it.qty===0){ cart.delete(id);} render(); }
  function subtotal(){ let s=0; cart.forEach(it=>{ s += it.price*it.qty; }); return q2(s); }
  function totals(){ const sub = subtotal(); const isCash = document.getElementById('pay_cash').checked; let rounding = 0, total = sub; if(isCash){ const r = round005(sub); rounding = q2(r - sub); total = r; } return {sub, rounding:q2(rounding), total:q2(total)}; }
  function render(){
    const list = document.getElementById('cart_list'); list.innerHTML='';
    cart.forEach(it=>{
      const row = document.createElement('div'); row.className='list-group-item d-flex justify-content-between align-items-center';
      row.innerHTML = '<div><div class="fw-semibold">'+it.name+'</div><div class="text-muted small">'+fmt(it.price)+'</div></div>'+
        '<div class="d-flex align-items-center gap-2">'+
        '<button class="btn btn-sm btn-outline-secondary" data-act="minus" data-id="'+it.id+'">−</button>'+
        '<span class="fw-bold">'+it.qty+'</span>'+
        '<button class="btn btn-sm btn-outline-secondary" data-act="plus" data-id="'+it.id+'">+</button>'+
        '<button class="btn btn-sm btn-outline-danger" data-act="rm" data-id="'+it.id+'"><i class="bi bi-x"></i></button>'+
        '</div>';
      list.appendChild(row);
    });
    const t = totals();
    document.getElementById('subtotal').textContent = fmt(t.sub);
    document.getElementById('rounding').textContent = fmt(t.rounding);
    document.getElementById('total').textContent = fmt(t.total);
    document.getElementById('submit_btn').disabled = cart.size===0;
  }
  document.querySelectorAll('.product-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      add({id:b.dataset.id, name:b.dataset.name, price:b.dataset.price, vat:b.dataset.vat});
    });
  });
  document.getElementById('cart_list').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return; const id = btn.dataset.id; const act = btn.dataset.act; const it = cart.get(id); if(!it) return;
    if(act==='plus') setQty(id, it.qty+1); else if(act==='minus') setQty(id, it.qty-1); else if(act==='rm') setQty(id,0);
  });
  document.getElementById('pay_card').addEventListener('change', render);
  document.getElementById('pay_cash').addEventListener('change', render);
  document.getElementById('posForm').addEventListener('submit', (e)=>{
    const data = []; cart.forEach(it=> data.push({product_id: it.id, quantity: it.qty}));
    document.getElementById('cart_json').value = JSON.stringify(data);
    document.getElementById('payment_method').value = document.getElementById('pay_cash').checked ? 'cash' : 'card';
  });
  render();
})();
</script>
{% endblock %}
